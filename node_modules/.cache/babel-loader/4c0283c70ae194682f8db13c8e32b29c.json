{"ast":null,"code":"import { Color } from '../../math/Color.js';\nimport { Matrix4 } from '../../math/Matrix4.js';\nimport { Vector2 } from '../../math/Vector2.js';\nimport { Vector3 } from '../../math/Vector3.js';\nimport { UniformsLib } from '../shaders/UniformsLib.js';\n\nfunction UniformsCache() {\n  var lights = {};\n  return {\n    get: function get(light) {\n      if (lights[light.id] !== undefined) {\n        return lights[light.id];\n      }\n\n      var uniforms;\n\n      switch (light.type) {\n        case 'DirectionalLight':\n          uniforms = {\n            direction: new Vector3(),\n            color: new Color()\n          };\n          break;\n\n        case 'SpotLight':\n          uniforms = {\n            position: new Vector3(),\n            direction: new Vector3(),\n            color: new Color(),\n            distance: 0,\n            coneCos: 0,\n            penumbraCos: 0,\n            decay: 0\n          };\n          break;\n\n        case 'PointLight':\n          uniforms = {\n            position: new Vector3(),\n            color: new Color(),\n            distance: 0,\n            decay: 0\n          };\n          break;\n\n        case 'HemisphereLight':\n          uniforms = {\n            direction: new Vector3(),\n            skyColor: new Color(),\n            groundColor: new Color()\n          };\n          break;\n\n        case 'RectAreaLight':\n          uniforms = {\n            color: new Color(),\n            position: new Vector3(),\n            halfWidth: new Vector3(),\n            halfHeight: new Vector3()\n          };\n          break;\n      }\n\n      lights[light.id] = uniforms;\n      return uniforms;\n    }\n  };\n}\n\nfunction ShadowUniformsCache() {\n  var lights = {};\n  return {\n    get: function get(light) {\n      if (lights[light.id] !== undefined) {\n        return lights[light.id];\n      }\n\n      var uniforms;\n\n      switch (light.type) {\n        case 'DirectionalLight':\n          uniforms = {\n            shadowBias: 0,\n            shadowNormalBias: 0,\n            shadowRadius: 1,\n            shadowMapSize: new Vector2()\n          };\n          break;\n\n        case 'SpotLight':\n          uniforms = {\n            shadowBias: 0,\n            shadowNormalBias: 0,\n            shadowRadius: 1,\n            shadowMapSize: new Vector2()\n          };\n          break;\n\n        case 'PointLight':\n          uniforms = {\n            shadowBias: 0,\n            shadowNormalBias: 0,\n            shadowRadius: 1,\n            shadowMapSize: new Vector2(),\n            shadowCameraNear: 1,\n            shadowCameraFar: 1000\n          };\n          break;\n        // TODO (abelnation): set RectAreaLight shadow uniforms\n      }\n\n      lights[light.id] = uniforms;\n      return uniforms;\n    }\n  };\n}\n\nvar nextVersion = 0;\n\nfunction shadowCastingLightsFirst(lightA, lightB) {\n  return (lightB.castShadow ? 1 : 0) - (lightA.castShadow ? 1 : 0);\n}\n\nfunction WebGLLights() {\n  var cache = new UniformsCache();\n  var shadowCache = ShadowUniformsCache();\n  var state = {\n    version: 0,\n    hash: {\n      directionalLength: -1,\n      pointLength: -1,\n      spotLength: -1,\n      rectAreaLength: -1,\n      hemiLength: -1,\n      numDirectionalShadows: -1,\n      numPointShadows: -1,\n      numSpotShadows: -1\n    },\n    ambient: [0, 0, 0],\n    probe: [],\n    directional: [],\n    directionalShadow: [],\n    directionalShadowMap: [],\n    directionalShadowMatrix: [],\n    spot: [],\n    spotShadow: [],\n    spotShadowMap: [],\n    spotShadowMatrix: [],\n    rectArea: [],\n    rectAreaLTC1: null,\n    rectAreaLTC2: null,\n    point: [],\n    pointShadow: [],\n    pointShadowMap: [],\n    pointShadowMatrix: [],\n    hemi: []\n  };\n\n  for (var i = 0; i < 9; i++) {\n    state.probe.push(new Vector3());\n  }\n\n  var vector3 = new Vector3();\n  var matrix4 = new Matrix4();\n  var matrix42 = new Matrix4();\n\n  function setup(lights, shadows, camera) {\n    var r = 0,\n        g = 0,\n        b = 0;\n\n    for (var _i = 0; _i < 9; _i++) {\n      state.probe[_i].set(0, 0, 0);\n    }\n\n    var directionalLength = 0;\n    var pointLength = 0;\n    var spotLength = 0;\n    var rectAreaLength = 0;\n    var hemiLength = 0;\n    var numDirectionalShadows = 0;\n    var numPointShadows = 0;\n    var numSpotShadows = 0;\n    var viewMatrix = camera.matrixWorldInverse;\n    lights.sort(shadowCastingLightsFirst);\n\n    for (var _i2 = 0, l = lights.length; _i2 < l; _i2++) {\n      var light = lights[_i2];\n      var color = light.color;\n      var intensity = light.intensity;\n      var distance = light.distance;\n      var shadowMap = light.shadow && light.shadow.map ? light.shadow.map.texture : null;\n\n      if (light.isAmbientLight) {\n        r += color.r * intensity;\n        g += color.g * intensity;\n        b += color.b * intensity;\n      } else if (light.isLightProbe) {\n        for (var j = 0; j < 9; j++) {\n          state.probe[j].addScaledVector(light.sh.coefficients[j], intensity);\n        }\n      } else if (light.isDirectionalLight) {\n        var uniforms = cache.get(light);\n        uniforms.color.copy(light.color).multiplyScalar(light.intensity);\n        uniforms.direction.setFromMatrixPosition(light.matrixWorld);\n        vector3.setFromMatrixPosition(light.target.matrixWorld);\n        uniforms.direction.sub(vector3);\n        uniforms.direction.transformDirection(viewMatrix);\n\n        if (light.castShadow) {\n          var shadow = light.shadow;\n          var shadowUniforms = shadowCache.get(light);\n          shadowUniforms.shadowBias = shadow.bias;\n          shadowUniforms.shadowNormalBias = shadow.normalBias;\n          shadowUniforms.shadowRadius = shadow.radius;\n          shadowUniforms.shadowMapSize = shadow.mapSize;\n          state.directionalShadow[directionalLength] = shadowUniforms;\n          state.directionalShadowMap[directionalLength] = shadowMap;\n          state.directionalShadowMatrix[directionalLength] = light.shadow.matrix;\n          numDirectionalShadows++;\n        }\n\n        state.directional[directionalLength] = uniforms;\n        directionalLength++;\n      } else if (light.isSpotLight) {\n        var _uniforms = cache.get(light);\n\n        _uniforms.position.setFromMatrixPosition(light.matrixWorld);\n\n        _uniforms.position.applyMatrix4(viewMatrix);\n\n        _uniforms.color.copy(color).multiplyScalar(intensity);\n\n        _uniforms.distance = distance;\n\n        _uniforms.direction.setFromMatrixPosition(light.matrixWorld);\n\n        vector3.setFromMatrixPosition(light.target.matrixWorld);\n\n        _uniforms.direction.sub(vector3);\n\n        _uniforms.direction.transformDirection(viewMatrix);\n\n        _uniforms.coneCos = Math.cos(light.angle);\n        _uniforms.penumbraCos = Math.cos(light.angle * (1 - light.penumbra));\n        _uniforms.decay = light.decay;\n\n        if (light.castShadow) {\n          var _shadow = light.shadow;\n\n          var _shadowUniforms = shadowCache.get(light);\n\n          _shadowUniforms.shadowBias = _shadow.bias;\n          _shadowUniforms.shadowNormalBias = _shadow.normalBias;\n          _shadowUniforms.shadowRadius = _shadow.radius;\n          _shadowUniforms.shadowMapSize = _shadow.mapSize;\n          state.spotShadow[spotLength] = _shadowUniforms;\n          state.spotShadowMap[spotLength] = shadowMap;\n          state.spotShadowMatrix[spotLength] = light.shadow.matrix;\n          numSpotShadows++;\n        }\n\n        state.spot[spotLength] = _uniforms;\n        spotLength++;\n      } else if (light.isRectAreaLight) {\n        var _uniforms2 = cache.get(light); // (a) intensity is the total visible light emitted\n        //uniforms.color.copy( color ).multiplyScalar( intensity / ( light.width * light.height * Math.PI ) );\n        // (b) intensity is the brightness of the light\n\n\n        _uniforms2.color.copy(color).multiplyScalar(intensity);\n\n        _uniforms2.position.setFromMatrixPosition(light.matrixWorld);\n\n        _uniforms2.position.applyMatrix4(viewMatrix); // extract local rotation of light to derive width/height half vectors\n\n\n        matrix42.identity();\n        matrix4.copy(light.matrixWorld);\n        matrix4.premultiply(viewMatrix);\n        matrix42.extractRotation(matrix4);\n\n        _uniforms2.halfWidth.set(light.width * 0.5, 0.0, 0.0);\n\n        _uniforms2.halfHeight.set(0.0, light.height * 0.5, 0.0);\n\n        _uniforms2.halfWidth.applyMatrix4(matrix42);\n\n        _uniforms2.halfHeight.applyMatrix4(matrix42); // TODO (abelnation): RectAreaLight distance?\n        // uniforms.distance = distance;\n\n\n        state.rectArea[rectAreaLength] = _uniforms2;\n        rectAreaLength++;\n      } else if (light.isPointLight) {\n        var _uniforms3 = cache.get(light);\n\n        _uniforms3.position.setFromMatrixPosition(light.matrixWorld);\n\n        _uniforms3.position.applyMatrix4(viewMatrix);\n\n        _uniforms3.color.copy(light.color).multiplyScalar(light.intensity);\n\n        _uniforms3.distance = light.distance;\n        _uniforms3.decay = light.decay;\n\n        if (light.castShadow) {\n          var _shadow2 = light.shadow;\n\n          var _shadowUniforms2 = shadowCache.get(light);\n\n          _shadowUniforms2.shadowBias = _shadow2.bias;\n          _shadowUniforms2.shadowNormalBias = _shadow2.normalBias;\n          _shadowUniforms2.shadowRadius = _shadow2.radius;\n          _shadowUniforms2.shadowMapSize = _shadow2.mapSize;\n          _shadowUniforms2.shadowCameraNear = _shadow2.camera.near;\n          _shadowUniforms2.shadowCameraFar = _shadow2.camera.far;\n          state.pointShadow[pointLength] = _shadowUniforms2;\n          state.pointShadowMap[pointLength] = shadowMap;\n          state.pointShadowMatrix[pointLength] = light.shadow.matrix;\n          numPointShadows++;\n        }\n\n        state.point[pointLength] = _uniforms3;\n        pointLength++;\n      } else if (light.isHemisphereLight) {\n        var _uniforms4 = cache.get(light);\n\n        _uniforms4.direction.setFromMatrixPosition(light.matrixWorld);\n\n        _uniforms4.direction.transformDirection(viewMatrix);\n\n        _uniforms4.direction.normalize();\n\n        _uniforms4.skyColor.copy(light.color).multiplyScalar(intensity);\n\n        _uniforms4.groundColor.copy(light.groundColor).multiplyScalar(intensity);\n\n        state.hemi[hemiLength] = _uniforms4;\n        hemiLength++;\n      }\n    }\n\n    if (rectAreaLength > 0) {\n      state.rectAreaLTC1 = UniformsLib.LTC_1;\n      state.rectAreaLTC2 = UniformsLib.LTC_2;\n    }\n\n    state.ambient[0] = r;\n    state.ambient[1] = g;\n    state.ambient[2] = b;\n    var hash = state.hash;\n\n    if (hash.directionalLength !== directionalLength || hash.pointLength !== pointLength || hash.spotLength !== spotLength || hash.rectAreaLength !== rectAreaLength || hash.hemiLength !== hemiLength || hash.numDirectionalShadows !== numDirectionalShadows || hash.numPointShadows !== numPointShadows || hash.numSpotShadows !== numSpotShadows) {\n      state.directional.length = directionalLength;\n      state.spot.length = spotLength;\n      state.rectArea.length = rectAreaLength;\n      state.point.length = pointLength;\n      state.hemi.length = hemiLength;\n      state.directionalShadow.length = numDirectionalShadows;\n      state.directionalShadowMap.length = numDirectionalShadows;\n      state.pointShadow.length = numPointShadows;\n      state.pointShadowMap.length = numPointShadows;\n      state.spotShadow.length = numSpotShadows;\n      state.spotShadowMap.length = numSpotShadows;\n      state.directionalShadowMatrix.length = numDirectionalShadows;\n      state.pointShadowMatrix.length = numPointShadows;\n      state.spotShadowMatrix.length = numSpotShadows;\n      hash.directionalLength = directionalLength;\n      hash.pointLength = pointLength;\n      hash.spotLength = spotLength;\n      hash.rectAreaLength = rectAreaLength;\n      hash.hemiLength = hemiLength;\n      hash.numDirectionalShadows = numDirectionalShadows;\n      hash.numPointShadows = numPointShadows;\n      hash.numSpotShadows = numSpotShadows;\n      state.version = nextVersion++;\n    }\n  }\n\n  return {\n    setup: setup,\n    state: state\n  };\n}\n\nexport { WebGLLights };","map":{"version":3,"sources":["/Users/sebringrose/Projects/theEmpire/website/client/node_modules/three/src/renderers/webgl/WebGLLights.js"],"names":["Color","Matrix4","Vector2","Vector3","UniformsLib","UniformsCache","lights","get","light","id","undefined","uniforms","type","direction","color","position","distance","coneCos","penumbraCos","decay","skyColor","groundColor","halfWidth","halfHeight","ShadowUniformsCache","shadowBias","shadowNormalBias","shadowRadius","shadowMapSize","shadowCameraNear","shadowCameraFar","nextVersion","shadowCastingLightsFirst","lightA","lightB","castShadow","WebGLLights","cache","shadowCache","state","version","hash","directionalLength","pointLength","spotLength","rectAreaLength","hemiLength","numDirectionalShadows","numPointShadows","numSpotShadows","ambient","probe","directional","directionalShadow","directionalShadowMap","directionalShadowMatrix","spot","spotShadow","spotShadowMap","spotShadowMatrix","rectArea","rectAreaLTC1","rectAreaLTC2","point","pointShadow","pointShadowMap","pointShadowMatrix","hemi","i","push","vector3","matrix4","matrix42","setup","shadows","camera","r","g","b","set","viewMatrix","matrixWorldInverse","sort","l","length","intensity","shadowMap","shadow","map","texture","isAmbientLight","isLightProbe","j","addScaledVector","sh","coefficients","isDirectionalLight","copy","multiplyScalar","setFromMatrixPosition","matrixWorld","target","sub","transformDirection","shadowUniforms","bias","normalBias","radius","mapSize","matrix","isSpotLight","applyMatrix4","Math","cos","angle","penumbra","isRectAreaLight","identity","premultiply","extractRotation","width","height","isPointLight","near","far","isHemisphereLight","normalize","LTC_1","LTC_2"],"mappings":"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","sourcesContent":["import { Color } from '../../math/Color.js';\nimport { Matrix4 } from '../../math/Matrix4.js';\nimport { Vector2 } from '../../math/Vector2.js';\nimport { Vector3 } from '../../math/Vector3.js';\nimport { UniformsLib } from '../shaders/UniformsLib.js';\n\nfunction UniformsCache() {\n\n\tconst lights = {};\n\n\treturn {\n\n\t\tget: function ( light ) {\n\n\t\t\tif ( lights[ light.id ] !== undefined ) {\n\n\t\t\t\treturn lights[ light.id ];\n\n\t\t\t}\n\n\t\t\tlet uniforms;\n\n\t\t\tswitch ( light.type ) {\n\n\t\t\t\tcase 'DirectionalLight':\n\t\t\t\t\tuniforms = {\n\t\t\t\t\t\tdirection: new Vector3(),\n\t\t\t\t\t\tcolor: new Color()\n\t\t\t\t\t};\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'SpotLight':\n\t\t\t\t\tuniforms = {\n\t\t\t\t\t\tposition: new Vector3(),\n\t\t\t\t\t\tdirection: new Vector3(),\n\t\t\t\t\t\tcolor: new Color(),\n\t\t\t\t\t\tdistance: 0,\n\t\t\t\t\t\tconeCos: 0,\n\t\t\t\t\t\tpenumbraCos: 0,\n\t\t\t\t\t\tdecay: 0\n\t\t\t\t\t};\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'PointLight':\n\t\t\t\t\tuniforms = {\n\t\t\t\t\t\tposition: new Vector3(),\n\t\t\t\t\t\tcolor: new Color(),\n\t\t\t\t\t\tdistance: 0,\n\t\t\t\t\t\tdecay: 0\n\t\t\t\t\t};\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'HemisphereLight':\n\t\t\t\t\tuniforms = {\n\t\t\t\t\t\tdirection: new Vector3(),\n\t\t\t\t\t\tskyColor: new Color(),\n\t\t\t\t\t\tgroundColor: new Color()\n\t\t\t\t\t};\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'RectAreaLight':\n\t\t\t\t\tuniforms = {\n\t\t\t\t\t\tcolor: new Color(),\n\t\t\t\t\t\tposition: new Vector3(),\n\t\t\t\t\t\thalfWidth: new Vector3(),\n\t\t\t\t\t\thalfHeight: new Vector3()\n\t\t\t\t\t};\n\t\t\t\t\tbreak;\n\n\t\t\t}\n\n\t\t\tlights[ light.id ] = uniforms;\n\n\t\t\treturn uniforms;\n\n\t\t}\n\n\t};\n\n}\n\nfunction ShadowUniformsCache() {\n\n\tconst lights = {};\n\n\treturn {\n\n\t\tget: function ( light ) {\n\n\t\t\tif ( lights[ light.id ] !== undefined ) {\n\n\t\t\t\treturn lights[ light.id ];\n\n\t\t\t}\n\n\t\t\tlet uniforms;\n\n\t\t\tswitch ( light.type ) {\n\n\t\t\t\tcase 'DirectionalLight':\n\t\t\t\t\tuniforms = {\n\t\t\t\t\t\tshadowBias: 0,\n\t\t\t\t\t\tshadowNormalBias: 0,\n\t\t\t\t\t\tshadowRadius: 1,\n\t\t\t\t\t\tshadowMapSize: new Vector2()\n\t\t\t\t\t};\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'SpotLight':\n\t\t\t\t\tuniforms = {\n\t\t\t\t\t\tshadowBias: 0,\n\t\t\t\t\t\tshadowNormalBias: 0,\n\t\t\t\t\t\tshadowRadius: 1,\n\t\t\t\t\t\tshadowMapSize: new Vector2()\n\t\t\t\t\t};\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'PointLight':\n\t\t\t\t\tuniforms = {\n\t\t\t\t\t\tshadowBias: 0,\n\t\t\t\t\t\tshadowNormalBias: 0,\n\t\t\t\t\t\tshadowRadius: 1,\n\t\t\t\t\t\tshadowMapSize: new Vector2(),\n\t\t\t\t\t\tshadowCameraNear: 1,\n\t\t\t\t\t\tshadowCameraFar: 1000\n\t\t\t\t\t};\n\t\t\t\t\tbreak;\n\n\t\t\t\t// TODO (abelnation): set RectAreaLight shadow uniforms\n\n\t\t\t}\n\n\t\t\tlights[ light.id ] = uniforms;\n\n\t\t\treturn uniforms;\n\n\t\t}\n\n\t};\n\n}\n\n\n\nlet nextVersion = 0;\n\nfunction shadowCastingLightsFirst( lightA, lightB ) {\n\n\treturn ( lightB.castShadow ? 1 : 0 ) - ( lightA.castShadow ? 1 : 0 );\n\n}\n\nfunction WebGLLights() {\n\n\tconst cache = new UniformsCache();\n\n\tconst shadowCache = ShadowUniformsCache();\n\n\tconst state = {\n\n\t\tversion: 0,\n\n\t\thash: {\n\t\t\tdirectionalLength: - 1,\n\t\t\tpointLength: - 1,\n\t\t\tspotLength: - 1,\n\t\t\trectAreaLength: - 1,\n\t\t\themiLength: - 1,\n\n\t\t\tnumDirectionalShadows: - 1,\n\t\t\tnumPointShadows: - 1,\n\t\t\tnumSpotShadows: - 1\n\t\t},\n\n\t\tambient: [ 0, 0, 0 ],\n\t\tprobe: [],\n\t\tdirectional: [],\n\t\tdirectionalShadow: [],\n\t\tdirectionalShadowMap: [],\n\t\tdirectionalShadowMatrix: [],\n\t\tspot: [],\n\t\tspotShadow: [],\n\t\tspotShadowMap: [],\n\t\tspotShadowMatrix: [],\n\t\trectArea: [],\n\t\trectAreaLTC1: null,\n\t\trectAreaLTC2: null,\n\t\tpoint: [],\n\t\tpointShadow: [],\n\t\tpointShadowMap: [],\n\t\tpointShadowMatrix: [],\n\t\themi: []\n\n\t};\n\n\tfor ( let i = 0; i < 9; i ++ ) state.probe.push( new Vector3() );\n\n\tconst vector3 = new Vector3();\n\tconst matrix4 = new Matrix4();\n\tconst matrix42 = new Matrix4();\n\n\tfunction setup( lights, shadows, camera ) {\n\n\t\tlet r = 0, g = 0, b = 0;\n\n\t\tfor ( let i = 0; i < 9; i ++ ) state.probe[ i ].set( 0, 0, 0 );\n\n\t\tlet directionalLength = 0;\n\t\tlet pointLength = 0;\n\t\tlet spotLength = 0;\n\t\tlet rectAreaLength = 0;\n\t\tlet hemiLength = 0;\n\n\t\tlet numDirectionalShadows = 0;\n\t\tlet numPointShadows = 0;\n\t\tlet numSpotShadows = 0;\n\n\t\tconst viewMatrix = camera.matrixWorldInverse;\n\n\t\tlights.sort( shadowCastingLightsFirst );\n\n\t\tfor ( let i = 0, l = lights.length; i < l; i ++ ) {\n\n\t\t\tconst light = lights[ i ];\n\n\t\t\tconst color = light.color;\n\t\t\tconst intensity = light.intensity;\n\t\t\tconst distance = light.distance;\n\n\t\t\tconst shadowMap = ( light.shadow && light.shadow.map ) ? light.shadow.map.texture : null;\n\n\t\t\tif ( light.isAmbientLight ) {\n\n\t\t\t\tr += color.r * intensity;\n\t\t\t\tg += color.g * intensity;\n\t\t\t\tb += color.b * intensity;\n\n\t\t\t} else if ( light.isLightProbe ) {\n\n\t\t\t\tfor ( let j = 0; j < 9; j ++ ) {\n\n\t\t\t\t\tstate.probe[ j ].addScaledVector( light.sh.coefficients[ j ], intensity );\n\n\t\t\t\t}\n\n\t\t\t} else if ( light.isDirectionalLight ) {\n\n\t\t\t\tconst uniforms = cache.get( light );\n\n\t\t\t\tuniforms.color.copy( light.color ).multiplyScalar( light.intensity );\n\t\t\t\tuniforms.direction.setFromMatrixPosition( light.matrixWorld );\n\t\t\t\tvector3.setFromMatrixPosition( light.target.matrixWorld );\n\t\t\t\tuniforms.direction.sub( vector3 );\n\t\t\t\tuniforms.direction.transformDirection( viewMatrix );\n\n\t\t\t\tif ( light.castShadow ) {\n\n\t\t\t\t\tconst shadow = light.shadow;\n\n\t\t\t\t\tconst shadowUniforms = shadowCache.get( light );\n\n\t\t\t\t\tshadowUniforms.shadowBias = shadow.bias;\n\t\t\t\t\tshadowUniforms.shadowNormalBias = shadow.normalBias;\n\t\t\t\t\tshadowUniforms.shadowRadius = shadow.radius;\n\t\t\t\t\tshadowUniforms.shadowMapSize = shadow.mapSize;\n\n\t\t\t\t\tstate.directionalShadow[ directionalLength ] = shadowUniforms;\n\t\t\t\t\tstate.directionalShadowMap[ directionalLength ] = shadowMap;\n\t\t\t\t\tstate.directionalShadowMatrix[ directionalLength ] = light.shadow.matrix;\n\n\t\t\t\t\tnumDirectionalShadows ++;\n\n\t\t\t\t}\n\n\t\t\t\tstate.directional[ directionalLength ] = uniforms;\n\n\t\t\t\tdirectionalLength ++;\n\n\t\t\t} else if ( light.isSpotLight ) {\n\n\t\t\t\tconst uniforms = cache.get( light );\n\n\t\t\t\tuniforms.position.setFromMatrixPosition( light.matrixWorld );\n\t\t\t\tuniforms.position.applyMatrix4( viewMatrix );\n\n\t\t\t\tuniforms.color.copy( color ).multiplyScalar( intensity );\n\t\t\t\tuniforms.distance = distance;\n\n\t\t\t\tuniforms.direction.setFromMatrixPosition( light.matrixWorld );\n\t\t\t\tvector3.setFromMatrixPosition( light.target.matrixWorld );\n\t\t\t\tuniforms.direction.sub( vector3 );\n\t\t\t\tuniforms.direction.transformDirection( viewMatrix );\n\n\t\t\t\tuniforms.coneCos = Math.cos( light.angle );\n\t\t\t\tuniforms.penumbraCos = Math.cos( light.angle * ( 1 - light.penumbra ) );\n\t\t\t\tuniforms.decay = light.decay;\n\n\t\t\t\tif ( light.castShadow ) {\n\n\t\t\t\t\tconst shadow = light.shadow;\n\n\t\t\t\t\tconst shadowUniforms = shadowCache.get( light );\n\n\t\t\t\t\tshadowUniforms.shadowBias = shadow.bias;\n\t\t\t\t\tshadowUniforms.shadowNormalBias = shadow.normalBias;\n\t\t\t\t\tshadowUniforms.shadowRadius = shadow.radius;\n\t\t\t\t\tshadowUniforms.shadowMapSize = shadow.mapSize;\n\n\t\t\t\t\tstate.spotShadow[ spotLength ] = shadowUniforms;\n\t\t\t\t\tstate.spotShadowMap[ spotLength ] = shadowMap;\n\t\t\t\t\tstate.spotShadowMatrix[ spotLength ] = light.shadow.matrix;\n\n\t\t\t\t\tnumSpotShadows ++;\n\n\t\t\t\t}\n\n\t\t\t\tstate.spot[ spotLength ] = uniforms;\n\n\t\t\t\tspotLength ++;\n\n\t\t\t} else if ( light.isRectAreaLight ) {\n\n\t\t\t\tconst uniforms = cache.get( light );\n\n\t\t\t\t// (a) intensity is the total visible light emitted\n\t\t\t\t//uniforms.color.copy( color ).multiplyScalar( intensity / ( light.width * light.height * Math.PI ) );\n\n\t\t\t\t// (b) intensity is the brightness of the light\n\t\t\t\tuniforms.color.copy( color ).multiplyScalar( intensity );\n\n\t\t\t\tuniforms.position.setFromMatrixPosition( light.matrixWorld );\n\t\t\t\tuniforms.position.applyMatrix4( viewMatrix );\n\n\t\t\t\t// extract local rotation of light to derive width/height half vectors\n\t\t\t\tmatrix42.identity();\n\t\t\t\tmatrix4.copy( light.matrixWorld );\n\t\t\t\tmatrix4.premultiply( viewMatrix );\n\t\t\t\tmatrix42.extractRotation( matrix4 );\n\n\t\t\t\tuniforms.halfWidth.set( light.width * 0.5, 0.0, 0.0 );\n\t\t\t\tuniforms.halfHeight.set( 0.0, light.height * 0.5, 0.0 );\n\n\t\t\t\tuniforms.halfWidth.applyMatrix4( matrix42 );\n\t\t\t\tuniforms.halfHeight.applyMatrix4( matrix42 );\n\n\t\t\t\t// TODO (abelnation): RectAreaLight distance?\n\t\t\t\t// uniforms.distance = distance;\n\n\t\t\t\tstate.rectArea[ rectAreaLength ] = uniforms;\n\n\t\t\t\trectAreaLength ++;\n\n\t\t\t} else if ( light.isPointLight ) {\n\n\t\t\t\tconst uniforms = cache.get( light );\n\n\t\t\t\tuniforms.position.setFromMatrixPosition( light.matrixWorld );\n\t\t\t\tuniforms.position.applyMatrix4( viewMatrix );\n\n\t\t\t\tuniforms.color.copy( light.color ).multiplyScalar( light.intensity );\n\t\t\t\tuniforms.distance = light.distance;\n\t\t\t\tuniforms.decay = light.decay;\n\n\t\t\t\tif ( light.castShadow ) {\n\n\t\t\t\t\tconst shadow = light.shadow;\n\n\t\t\t\t\tconst shadowUniforms = shadowCache.get( light );\n\n\t\t\t\t\tshadowUniforms.shadowBias = shadow.bias;\n\t\t\t\t\tshadowUniforms.shadowNormalBias = shadow.normalBias;\n\t\t\t\t\tshadowUniforms.shadowRadius = shadow.radius;\n\t\t\t\t\tshadowUniforms.shadowMapSize = shadow.mapSize;\n\t\t\t\t\tshadowUniforms.shadowCameraNear = shadow.camera.near;\n\t\t\t\t\tshadowUniforms.shadowCameraFar = shadow.camera.far;\n\n\t\t\t\t\tstate.pointShadow[ pointLength ] = shadowUniforms;\n\t\t\t\t\tstate.pointShadowMap[ pointLength ] = shadowMap;\n\t\t\t\t\tstate.pointShadowMatrix[ pointLength ] = light.shadow.matrix;\n\n\t\t\t\t\tnumPointShadows ++;\n\n\t\t\t\t}\n\n\t\t\t\tstate.point[ pointLength ] = uniforms;\n\n\t\t\t\tpointLength ++;\n\n\t\t\t} else if ( light.isHemisphereLight ) {\n\n\t\t\t\tconst uniforms = cache.get( light );\n\n\t\t\t\tuniforms.direction.setFromMatrixPosition( light.matrixWorld );\n\t\t\t\tuniforms.direction.transformDirection( viewMatrix );\n\t\t\t\tuniforms.direction.normalize();\n\n\t\t\t\tuniforms.skyColor.copy( light.color ).multiplyScalar( intensity );\n\t\t\t\tuniforms.groundColor.copy( light.groundColor ).multiplyScalar( intensity );\n\n\t\t\t\tstate.hemi[ hemiLength ] = uniforms;\n\n\t\t\t\themiLength ++;\n\n\t\t\t}\n\n\t\t}\n\n\t\tif ( rectAreaLength > 0 ) {\n\n\t\t\tstate.rectAreaLTC1 = UniformsLib.LTC_1;\n\t\t\tstate.rectAreaLTC2 = UniformsLib.LTC_2;\n\n\t\t}\n\n\t\tstate.ambient[ 0 ] = r;\n\t\tstate.ambient[ 1 ] = g;\n\t\tstate.ambient[ 2 ] = b;\n\n\t\tconst hash = state.hash;\n\n\t\tif ( hash.directionalLength !== directionalLength ||\n\t\t\thash.pointLength !== pointLength ||\n\t\t\thash.spotLength !== spotLength ||\n\t\t\thash.rectAreaLength !== rectAreaLength ||\n\t\t\thash.hemiLength !== hemiLength ||\n\t\t\thash.numDirectionalShadows !== numDirectionalShadows ||\n\t\t\thash.numPointShadows !== numPointShadows ||\n\t\t\thash.numSpotShadows !== numSpotShadows ) {\n\n\t\t\tstate.directional.length = directionalLength;\n\t\t\tstate.spot.length = spotLength;\n\t\t\tstate.rectArea.length = rectAreaLength;\n\t\t\tstate.point.length = pointLength;\n\t\t\tstate.hemi.length = hemiLength;\n\n\t\t\tstate.directionalShadow.length = numDirectionalShadows;\n\t\t\tstate.directionalShadowMap.length = numDirectionalShadows;\n\t\t\tstate.pointShadow.length = numPointShadows;\n\t\t\tstate.pointShadowMap.length = numPointShadows;\n\t\t\tstate.spotShadow.length = numSpotShadows;\n\t\t\tstate.spotShadowMap.length = numSpotShadows;\n\t\t\tstate.directionalShadowMatrix.length = numDirectionalShadows;\n\t\t\tstate.pointShadowMatrix.length = numPointShadows;\n\t\t\tstate.spotShadowMatrix.length = numSpotShadows;\n\n\t\t\thash.directionalLength = directionalLength;\n\t\t\thash.pointLength = pointLength;\n\t\t\thash.spotLength = spotLength;\n\t\t\thash.rectAreaLength = rectAreaLength;\n\t\t\thash.hemiLength = hemiLength;\n\n\t\t\thash.numDirectionalShadows = numDirectionalShadows;\n\t\t\thash.numPointShadows = numPointShadows;\n\t\t\thash.numSpotShadows = numSpotShadows;\n\n\t\t\tstate.version = nextVersion ++;\n\n\t\t}\n\n\t}\n\n\treturn {\n\t\tsetup: setup,\n\t\tstate: state\n\t};\n\n}\n\n\nexport { WebGLLights };\n"]},"metadata":{},"sourceType":"module"}